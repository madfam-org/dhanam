# Dhanam Ledger

> Comprehensive budget and wealth tracking application with ESG crypto insights, targeting LATAM-first users with multilingual support (English/Spanish).

- Production URLs: app.dhan.am (web), api.dhan.am (API), admin.dhan.am (admin)
- Part of the MADFAM ecosystem — uses Janua for auth (OIDC SSO) and Enclii for deployment (bare metal K8s)
- Stack: Next.js 15/16, React Native + Expo, NestJS (Fastify), PostgreSQL (Prisma), Redis (BullMQ)
- Monorepo: Turborepo + pnpm — 4 apps, 6 packages
- API: 32 fully implemented modules with Swagger docs
- Test coverage: 80%+ across the codebase
- License: AGPL-3.0

---

## Project Overview

Dhanam Ledger unifies personal and business financial management with ESG crypto insights. It targets LATAM-first users with multilingual support (English/Spanish) and integrates with regional financial providers.

### Core Features

- **Multi-Space Management**: Separate personal and business finances with role-based access (owner, admin, member, viewer)
- **Bank Integration**: Belvo (Mexico), Plaid (US), Bitso (crypto exchange) with provider orchestration and failover
- **Budget Tracking**: Category-based budgets with caps, rules-based auto-categorization, and alerts
- **AI-Powered Categorization**: ML transaction categorization with merchant normalization and user correction loop
- **Wealth Management**: Net worth tracking, asset allocation views, daily valuation snapshots
- **DeFi/Web3 Portfolios**: Zapper integration across 7 networks (Ethereum, Polygon, Arbitrum, Optimism, Base, Avalanche, BSC) for Uniswap, Aave, Compound, Curve, Lido positions
- **Real Estate Tracking**: Zillow Zestimate integration for automated property valuations
- **Collectibles Valuation**: Adapter-based pricing for sneakers, watches, art, wine, coins, cards, cars
- **ESG Scoring**: Environmental, Social, Governance composite scores for crypto assets via Dhanam package
- **Financial Projections**: 60-day cashflow forecasting (weekly granularity) and 10-30 year projections with Monte Carlo simulation
- **Estate Planning**: Digital wills, beneficiary designations, Life Beat dead man's switch (30/60/90 day escalation)
- **Household Views**: Yours/Mine/Ours ownership filtering with joint/individual/trust account types
- **Document Storage**: Cloudflare R2-backed attachments for manual assets
- **Multi-Platform**: Web dashboard (Next.js 15), admin console (Next.js 16), and mobile app (React Native + Expo)

### Production Status

| Service | Domain | Status |
|---------|--------|--------|
| Web Dashboard | app.dhan.am | Running on Enclii |
| API Backend | api.dhan.am | Running on Enclii |
| Admin Panel | admin.dhan.am | Running on Enclii |

Authentication: Janua SSO with OAuth 2.0/OIDC (PKCE flow enforced), client ID `dhanam-ledger`, issuer `https://auth.madfam.io`.
Infrastructure: 2-node Hetzner cluster via Enclii PaaS — "The Sanctuary" (AX41-NVMe, production) and "The Forge" (CPX11, builds). Zero-trust ingress via Cloudflare Tunnel.

---

## Monorepo Structure

```
dhanam/
├── apps/
│   ├── admin/         # Next.js 16 admin dashboard (port 3400)
│   │                  # User search, read-only impersonation, feature flags, audit logs
│   ├── api/           # NestJS (Fastify) backend API (port 4010)
│   │                  # 32 modules, Prisma ORM, BullMQ jobs, Swagger docs
│   ├── mobile/        # React Native + Expo mobile app
│   │                  # iOS/Android with shared business logic
│   └── web/           # Next.js 15 user dashboard (port 3040)
│                      # App Router, Tailwind CSS, shadcn/ui, Zustand, React Query
├── packages/
│   ├── config/        # Shared ESLint, tsconfig, prettier presets
│   ├── esg/           # Dhanam ESG scoring adapters for crypto assets
│   ├── shared/        # Shared TypeScript types, utils, constants, i18n (EN/ES)
│   ├── simulations/   # Monte Carlo engine, scenario analysis, retirement projections
│   ├── billing-sdk/   # Typed client for Dhanam billing API (checkout, subscriptions, webhooks)
│   └── ui/            # Reusable UI components built on shadcn-ui
├── infra/
│   └── docker/        # Docker Compose for local dev (postgres, redis, mailhog)
├── docs/              # Architecture, API, ADRs, guides, audits
├── tools/             # Agent manifest, scripts
└── .enclii.yml        # Enclii deployment configuration
```

---

## Development Setup

### Prerequisites

- Node.js 20+, pnpm 8+, Docker & Docker Compose, Git

### NPM Registry

Dhanam uses MADFAM's private npm registry for internal packages:

```
@madfam:registry=https://npm.madfam.io
@dhanam:registry=https://npm.madfam.io
@janua:registry=https://npm.madfam.io
//npm.madfam.io/:_authToken=${NPM_MADFAM_TOKEN}
```

### Quick Start

```bash
git clone https://github.com/madfam-org/dhanam.git && cd dhanam
pnpm install
pnpm dev:infra          # Start postgres, redis, mailhog via Docker
cp apps/api/.env.example apps/api/.env
cp apps/web/.env.example apps/web/.env
pnpm db:push            # Prisma schema sync
pnpm db:seed            # Seed demo data (demo@dhanam.app / demo123)
pnpm dev                # Start all dev servers
```

### Available Scripts

| Command | Description |
|---------|-------------|
| `pnpm dev` | Start all apps in dev mode |
| `pnpm build` | Build all apps and packages |
| `pnpm test` | Run tests across monorepo |
| `pnpm lint` | Lint all code |
| `pnpm format` | Format with Prettier |
| `pnpm clean` | Clean build artifacts |
| `pnpm db:generate` | Generate Prisma client |
| `pnpm db:push` | Push schema to database |
| `pnpm db:seed` | Seed with sample data |
| `pnpm dev:infra` | Start local Docker services |
| `pnpm dev:api` | API server at localhost:4010 |
| `pnpm dev:web` | Web dashboard at localhost:3040 |
| `pnpm dev:admin` | Admin dashboard at localhost:3400 |

---

## Architecture Overview

Dhanam is a full-stack financial management platform built as a monorepo using Turborepo and pnpm.

### Layer Architecture

```
Clients (Web, Mobile, Admin, Swagger) → API Gateway (Cloudflare Tunnel)
  → NestJS API (Fastify) with modules: Auth, Spaces, Accounts, Transactions,
    Budgets, Analytics, ESG, Providers, ML, Jobs, Billing, Admin, etc.
  → Data Layer: PostgreSQL (Prisma), Redis (cache), BullMQ (jobs)
  → External Integrations: Belvo, Plaid, Bitso, Zapper, Zillow, Banxico
```

### Key Architectural Patterns

- **Multi-Tenant via Spaces**: Personal + Business entities with role-based access
- **Provider Orchestrator**: Circuit breaker, rate limiting, failover across financial data providers
- **Background Processing**: BullMQ queues for hourly syncs, FX rate updates, email jobs, cashflow forecasts
- **Data Normalization**: All provider data normalized into common schema regardless of source
- **Daily Valuations**: Snapshot-based wealth tracking for trend analysis

### Security Architecture

- JWT access tokens (15min) with rotating refresh tokens (30d)
- Argon2id password hashing with breach checks
- AES-256-GCM encryption for provider tokens at rest
- TOTP 2FA (required for admin ops, optional for users)
- HMAC-SHA256 webhook verification with replay protection
- Helmet.js security headers, CORS, rate limiting
- Prisma ORM for SQL injection prevention
- Comprehensive audit logging for sensitive operations

---

## API Module Map (32 Modules)

### Core Modules

| Module | Description |
|--------|-------------|
| accounts | Bank/crypto/investment account CRUD with provider connections |
| transactions | Transaction management, filtering, bulk operations |
| budgets | YNAB-style budgeting with category caps and period tracking |
| categories | Category management with rules-based auto-categorization engine |
| spaces | Multi-tenant space management (personal/business) |
| users | User profiles, preferences, locale settings |

### Analytics & Reporting

| Module | Description |
|--------|-------------|
| analytics | Financial analytics, spending trends, income/expense breakdowns |
| simulations | Monte Carlo retirement projections, scenario analysis |
| goals | Goal tracking with probability calculations and sharing |
| esg | ESG composite scoring API for crypto portfolio assets |

### Provider Integration

| Module | Description |
|--------|-------------|
| providers/orchestrator | Multi-provider coordination with failover and circuit breaker |
| providers/belvo | Mexico banking integration (OAuth, 90+ day history) |
| providers/plaid | US banking integration (Link SDK, webhooks) |
| providers/bitso | Crypto exchange integration (real-time positions) |
| providers/defi | DeFi tracking via Zapper (7 networks, 6+ protocols) |
| providers/blockchain | Non-custodial ETH/BTC/xPub address tracking |

### ML & Automation

| Module | Description |
|--------|-------------|
| ml | Transaction categorization ML with learning loop |
| recurring | Recurring transaction detection and management |
| jobs | BullMQ background job processing (sync, FX, email, forecasts) |

### Billing & Admin

| Module | Description |
|--------|-------------|
| billing | Stripe/Paddle subscription management (community/essentials/pro) |
| admin | User search, read-only impersonation, feature flags, audit trails |

### Other Modules

| Module | Description |
|--------|-------------|
| manual-assets | Manual asset tracking (real estate, vehicles, PE, collectibles) |
| estate-planning | Digital wills, beneficiary designations, Life Beat dead man's switch |
| households | Household management with yours/mine/ours views |
| fx-rates | Banxico FX rate fetching and caching (MXN/USD/EUR) |
| storage | Cloudflare R2 document storage for asset attachments |
| email | Transactional email service (weekly summaries, monthly reports) |
| onboarding | User onboarding flow management |
| search | Natural language search across financial data |

---

## Key API Endpoints

### Authentication

```
POST /v1/auth/login          # Email + password login → JWT tokens
POST /v1/auth/register       # Create new account
POST /v1/auth/refresh        # Rotate access token via refresh token
POST /v1/auth/logout         # Invalidate tokens
POST /v1/auth/2fa/setup      # Initialize TOTP 2FA
POST /v1/auth/2fa/verify     # Verify TOTP code
```

Token lifecycle: access token (15min), refresh token (30d, rotates on use). 2FA required for admin operations.

### Spaces

```
GET    /v1/spaces             # List user's spaces (personal/business)
POST   /v1/spaces             # Create space with name, type, currency
PUT    /v1/spaces/:id         # Update space details
DELETE /v1/spaces/:id         # Delete space (admin only)
```

### Accounts

```
GET    /v1/accounts           # List accounts (filter by spaceId, provider, type)
POST   /v1/accounts           # Create manual account
POST   /v1/accounts/connect   # Connect via provider (Belvo/Plaid/Bitso)
POST   /v1/accounts/:id/sync  # Trigger manual sync
```

Account types: checking, savings, credit, investment, crypto, other.
Providers: belvo, plaid, mx, finicity, bitso, blockchain, manual.

### Transactions

```
GET    /v1/transactions       # List with pagination, filtering, date range
POST   /v1/transactions       # Create manual transaction
PUT    /v1/transactions/:id   # Update (including category correction for ML)
DELETE /v1/transactions/:id   # Delete transaction
POST   /v1/transactions/bulk  # Bulk import (100+ items <2s p95)
```

---

## Database Schema (Key Enums)

```prisma
enum SpaceType       { personal, business }
enum SpaceRole       { owner, admin, member, viewer }
enum AccountType     { checking, savings, credit, investment, crypto, other }
enum Provider        { belvo, plaid, mx, finicity, bitso, blockchain, manual }
enum ConnectionStatus { active, error, syncing, disconnected }
enum BudgetPeriod    { monthly, quarterly, yearly }
enum Currency        { MXN, USD, EUR }
enum SubscriptionTier { community, essentials, pro }
enum ManualAssetType { real_estate, vehicle, domain, private_equity, angel_investment, collectible, art, jewelry, other }
enum AccountOwnership { individual, joint, trust }
enum GoalType        { retirement, education, house_purchase, emergency_fund, legacy, travel, business, debt_payoff, other }
enum GoalStatus      { active, paused, achieved, abandoned }
```

Key models: User → SpaceMember → Space → Account → Transaction, Space → Budget → Category (with rules), DailyValuation snapshots, EsgScore, AuditLog.

Full schema: `apps/api/prisma/schema.prisma`

---

## Architecture Decision Records

### ADR-001: NestJS with Fastify over Express

Chose NestJS with Fastify adapter for the backend framework. Fastify provides 5x faster JSON serialization than Express, while NestJS adds modular architecture, TypeScript-first design, and built-in OpenAPI/Swagger integration. Trade-off: smaller middleware ecosystem than Express.

### ADR-002: Prisma ORM for Database Access

Selected Prisma as primary ORM for PostgreSQL. Benefits: schema-first approach with declarative modeling, fully type-safe generated client, built-in migration system, Decimal type for financial precision. Evaluated against TypeORM, Drizzle, and Knex — Prisma won on developer experience and type safety.

### ADR-003: Multi-Provider Financial Data Strategy

Implemented provider orchestrator with failover across multiple financial data providers. Belvo (Mexico banking), Plaid (US banking), MX/Finicity (US/Canada), Bitso (crypto exchange), Zapper (DeFi across 7 networks), Zillow (real estate). Architecture uses circuit breaker pattern, rate limiting, and data normalization into common schema.

### ADR-004: Janua Authentication Integration

Uses Janua (MADFAM's internal SSO platform) for all authentication via OIDC. Features: PKCE flow, TOTP 2FA, short-lived access tokens (15min), refresh token rotation (30d), session binding. Organization/space mapping for multi-tenant authorization. Social logins (GitHub, Google) handled by Janua.

### ADR-005: Enclii Deployment Platform

Uses Enclii (MADFAM's internal PaaS) for production deployment. Auto-deploy on push to main branch. Zero-downtime rolling deployments on bare metal Kubernetes (2-node Hetzner cluster). Horizontal pod autoscaling (2-8 replicas). Integrated monitoring and Janua auth.

---

## Deployment & Infrastructure

### Primary Method: Enclii PaaS

Deploy by pushing to `main` — Enclii detects, builds Docker images, and deploys to bare metal K8s.

Configuration in `.enclii.yml`:
- Build: Dockerfile at `apps/web/Dockerfile`
- Runtime: Port 3000, 2-8 replicas, 200m-1000m CPU, 512Mi-1Gi memory
- Domains: app.dhan.am (primary), admin.dhan.am, dhanam.madfam.io, dhan.am
- Health checks: `/api/health` (readiness + liveness)
- TLS: Cloudflare-issued certificates
- Autoscaling: CPU target 70%

### SLOs

- Availability: 99.9%
- Latency p95: 300ms
- Error rate: <0.5%

### Kubernetes Resources

Namespace `dhanam` with deployments: dhanam-api, dhanam-web, dhanam-admin.
Secrets: dhanam-secrets, dhanam-billing-secrets, ghcr-credentials.

### GitHub Actions CI/CD

- `ci.yml`, `lint.yml`, `test-coverage.yml` — Quality gates on all PRs
- `check-migrations.yml` — Database migration validation
- `publish-packages.yml` — Tag-triggered npm publish to npm.madfam.io (manual dispatch with dry-run)
- `deploy-enclii.yml`, `deploy-k8s.yml` — Manual/fallback deployment options

---

## MADFAM Ecosystem

Dhanam is part of the MADFAM platform ecosystem:

### Janua (Authentication)

All authentication is handled by Janua, MADFAM's SSO platform:
- OIDC Issuer: `https://auth.madfam.io`
- Janua API: `https://api.janua.dev`
- Client ID: `jnc_uE2zp9ume_Fd6jMl1elL6wqjiECM711t`
- Features: OAuth 2.0/OIDC with PKCE, social login (GitHub, Google), TOTP 2FA

**Do not** implement custom auth or use third-party auth providers.

### Enclii (Deployment)

All production deployments via Enclii, MADFAM's PaaS:
- Config: `.enclii.yml` at repo root
- Auto-deploy on push to `main`
- Bare metal K8s on Hetzner cluster

**Do not** deploy via other platforms. GitHub Actions are for CI quality gates only.

---

## Security Summary

### Authentication & Authorization

- Janua SSO (OIDC/PKCE) for all auth flows
- JWT access tokens (15min) + rotating refresh tokens (30d)
- TOTP 2FA via TOTP (required for admin, optional for users)
- Argon2id password hashing (64MB memory cost)
- Redis-backed session management

### Data Protection

- AES-256-GCM encryption for provider tokens and sensitive data at rest
- TLS 1.2+ for all communications
- HMAC-SHA256 webhook verification with timing-safe comparison and replay protection

### Infrastructure Security

- Helmet.js with CSP, X-Frame-Options, etc.
- CORS configuration, rate limiting
- Prisma ORM (parameterized queries prevent SQL injection)
- Class-validator for strict input validation
- Comprehensive audit logging

### Vulnerability Reporting

Email: security@dhanam.io
Response: 24h acknowledgment, 72h assessment, 7d remediation plan.
Severity: CVSS v3.1 classification (Critical 9.0+, High 7.0+, Medium 4.0+, Low <4.0).

---

## Tech Debt (Open Items)

| ID | Title | Severity | Status |
|----|-------|----------|--------|
| TD-001 | GHCR Container Build Workflow — K8s manifests reference GHCR images but no CI workflow builds/pushes them | CRITICAL | Missing |
| TD-002 | Database Provisioning API — DB provisioned via kubectl exec instead of Enclii API | HIGH | Missing |
| TD-004 | Billing Secrets Placeholder — Stripe/Paddle credentials are placeholder values | MEDIUM | Placeholder |

TD-003 (CI/CD Platform Migration) has been resolved — AWS infrastructure fully removed.

---

## Agent Guidance

### Critical Ecosystem Rules

1. **Authentication**: Use Janua only. Do NOT implement custom auth or use Auth0, Clerk, etc.
2. **Deployment**: Use Enclii only. Push to `main` to deploy. Do NOT configure other deployment platforms.
3. **API versioning**: All endpoints prefixed with `/v1`.

### Key Implementation Guidelines

- All provider tokens (Belvo, Plaid, Bitso) must be encrypted at rest using AES-256-GCM
- Normalize all financial data into common schema regardless of provider
- Default locale: Spanish (ES) for Mexico, English elsewhere
- Currency formatting for MXN/USD/EUR with Banxico FX rates
- All user-facing text must support i18n via `packages/shared/i18n`

### Performance Requirements

- Page loads <1.5s p95
- Manual account refresh <15s
- Bulk transaction operations (100+ items) <2s p95
- Background sync every hour via BullMQ queues

### Testing Strategy

- Unit tests for auth, rules engine, and provider adapters
- Contract tests for webhook handlers
- Snapshot tests for ESG score calculations
- 80%+ coverage target across branches, functions, lines, statements
- CI: Automated on every push/PR via GitHub Actions + Codecov

### PostHog Events

Tracked events: sign_up, onboarding_complete, connect_initiated, connect_success, sync_success, budget_created, rule_created, txn_categorized, alert_fired, view_net_worth, export_data.

### Machine-Readable Metadata

Full project metadata (domains, ports, K8s resources, build/test commands, dependencies) is available in `tools/agent-manifest.json`.
